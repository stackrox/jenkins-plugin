= StackRox Container Image Scanner Jenkins plugin
:toc: preamble
:toc-title: Contents
:icons: font
:stylesheet: docstyle.css
:image-path: ./src/img/
:plugin-name: StackRox Container Image Scanner
:product-name: StackRox Kubernetes Security Platform

The *{plugin-name}* plugin enables scanning of container
images for published software vulnerabilities. You can add it as a build step in
your freestyle projects or pipeline, to ensure your infrastructure is in
adherence with the {product-name} vulnerability
management policies.

The *link:https://www.stackrox.com/[{product-name}]* protects your cloud-native
applications across the entire container lifecycle: build, deploy, and runtime.
Leverage StackRox to gain visibility into your cloud-native environment, to
detect vulnerabilities and misconfigurations in your container images and
Kubernetes deployments, to identify high-risk runtime activity, and to meet your
internal and external compliance requirements.

[[prerequisites]]
== Prerequisites

To install, configure, and use the {plugin-name} plugin you
must meet the following requirements:

. Use Jenkins version LTS 2.204.1 or newer.
. Use the {product-name} version 3.0.38 or
  newer.
. link:https://help.stackrox.com/docs/use-the-api/#authentication[Create an API token] with the Continuous Integration (CI) role in the StackRox
  Kubernetes Security Platform.
. link:https://help.stackrox.com/docs/integrate-with-other-tools/integrate-with-image-registries/[Integrate the {product-name} with the image registry]
  you use.

[[install-the-stackrox-container-image-scanner-plugin]]
== Install the {plugin-name} plugin

You can use <<web-ui, Web UI>> or <<jenkins-cli, Jenkins CLI>> to install the
{plugin-name} plugin.

[[web-ui]]
=== Web UI

Use the Jenkins Plugin Manager in your Jenkins instance to install the StackRox
Container Image Scanner plugin.

. On the Jenkins homepage, go to the *Manage Jenkins* > *Manage Plugins* view.
. Select the *Available* tab.
. Enter *stackrox* in the *Filter* box to search for the StackRox Container
Image Scanner plugin.
. Select the checkbox under the *Install* column for the *StackRox Container
Image Scanner* plugin.
. Select *Install without restart*.


[[jenkins-cli]]
=== Jenkins CLI

Use the `install-plugin` command in
link:https://jenkins.io/doc/book/managing/cli/[Jenkins CLI] to install the
{plugin-name} plugin.

[source, bash]
----
java -jar jenkins-cli.jar -s <jenkins-address> install-plugin stackrox-container-image-scanner -deploy
----

[[use-the-stackrox-container-image-scanner-plugin]]
== Use the {plugin-name} plugin

You can use the {plugin-name} plugin in both freestyle
projects and pipelines.

[IMPORTANT]
====
You must push your images to the registry you configured in your build steps,
before you invoke the {plugin-name} plugin step in a
Jenkins FreeStyle project or a Pipeline.
====

[[freestyle-project]]
=== Freestyle project

. Add a build step in your project to save names of all the images you want to
scan in the `<jenkins-workspace>/${BUILD_TAG}/rox_images_to_scan` file. Each
image name must be on a separate line. 
+
[.bordered]
image::{image-path}build-step.png[]
+
For example, to do this:

- Select *Add build step* > *Execute shell*.
- In the command box, enter:
+

[source, bash]
----
mkdir $BUILD_TAG
cd $BUILD_TAG
echo "nginx:latest" >> rox_images_to_scan
echo "stackrox/vuln-images:django-cve-2019-14235" >> rox_images_to_scan
----

. Add the {plugin-name} plugin step. Select *Add build step* > *StackRox Image Security*.
. Enter details for the following plugin configuration variables:
+
[[plugin-configuration-variables]]
[%header,cols="1,1,2",cols="d,d,a"] 
|===
|Variable
|Name
|Description

|`portalAddress`
|Portal address ^*^
|Your StackRox Portal address.

|`apiToken`
|API token ^*^
|The StackRox access token with the Continuous Integration (CI) authorization role.

|`enableTLSVerification`
|Enable TLS verification
| Use it to enable TLS. You must also specify a CA certificate.

|`caCertPEM`
|CA certificate
|Use it to specify a CA certificate in PEM format. Make sure to include the
BEGIN CERTIFICATE and END CERTIFICATE tags for your certificate.

[NOTE]
====
You can download the certificate in PEM format from the sensor bundle in any
of cluster where you've installed StackRox Sensor. If you don't have
administrative access to your cluster, please ask your system administrator to
get the certificate.
====

|`failOnCriticalPluginError`
|Fail on critical plugin errors
|Enable this to fail the build if the plugin encounters any errors. This value
is `TRUE` by default.

|`failOnPolicyEvalFailure`
|Fail if policy violations exist
|Enable this to fail the build if scanned images violate any link:https://help.stackrox.com/docs/deploy-security-policies/[enforced system policies]
in the {product-name}. This value is `TRUE` by default.

[NOTE]
====
If you don't enable `failOnPolicyEvalFailure`, the plugin will not fail the build even if
the {product-name} reports system policy violations.
====

3+| _^*^ Required_
|===
+
[.bordered]
image::{image-path}plugin-config.png[]
+
. Select *Save* and then select *Apply*.


[[pipeline]]
=== Pipeline

To use the {plugin-name} plugin in your pipeline:

. Go to the pipeline configuration screen.
. In the *Script* text area, enter the following script:
+
----
node {
    stage('Stackrox Image Security') {
        steps {
            step ([
                $class: 'StackroxBuilder', <1>
                portalAddress: <portal-address>,
                apiToken: <api-token>,
                enableTLSVerification: <true-or-false>,
                caCertPEM: <ca-cert-pem-format>,
                failOnCriticalPluginError: <true-or-false>,
                failOnPolicyEvalFailure: <true-or-false>
                ])
        }
    }
}
----
<1> For more information about the variables, see the
<<plugin-configuration-variables, plugin configuration variables>> section.

+
[.bordered]
image::{image-path}plugin-pipeline.png[]


[[view-scan-reports]]
== View scan reports

Whenever you use the {plugin-name} plugin to scan images, the {plugin-name}
creates reports as build artifacts. These reports include detailed information
in CSV format. The {plugin-name} generates the following two CSV format reports
for every scanned image:

. CVEs found in the image.
. Policy violations for the image.

The {plugin-name} also creates an HTML report for every build. This report
includes a summary of the scan results for all scanned images in your
environment. 

To view the HTML report:

. Select *StackRox Image Security Report* from the left-hand navigation menu. 
+
[.bordered]
image::{image-path}view-html-report.png[]
+
