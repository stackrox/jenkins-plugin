version: 2.1

runOnAllTags: &runOnAllTags
  filters:
    tags:
      only: /.*/

runOnAllTagsWithDockerIOPullCtx: &runOnAllTagsWithDockerIOPullCtx
  <<: *runOnAllTags
  context: docker-io-pull

buildLivenessCheck: &buildLivenessCheck
  run:
    name: Ensure workflow is still live
    command: |
      .circleci/check-workflow-live.sh

setupClientTLSCerts: &setupClientTLSCerts
  run:
    name: Setup client auth TLS certificates
    command: |
      cert_dir="$(mktemp -d)"
      ./tests/scripts/setup-certs.sh "$cert_dir" "Client Certificate User" "Client CA"

      cci-export KEYSTORE_PATH "${cert_dir}/keystore.p12"
      cci-export CLIENT_CA_PATH "${cert_dir}/ca.crt"

waitForSensorK8s: &waitForSensorK8s
  run:
    name: Wait for the Sensor to be running K8s
    command: |
      ./scripts/ci/sensor-wait.sh

deleteClusterk8s: &deleteClusterk8s
  run:
    name: Tear down cluster upon failure
    command: |
      gcloud container clusters delete "$CLUSTER_NAME" --async
      when: on_fail


waitForAPI: &waitForAPI
  run:
    name: Wait for the API server to be up
    command: |
      export API_HOSTNAME=localhost
      export API_PORT=8000
      if [[ "${LOAD_BALANCER}" == "lb" ]]; then
        export API_HOSTNAME=$(./scripts/k8s/get-lb-ip.sh)
        export API_PORT=443
      fi
      export METADATA_URL="https://${API_HOSTNAME}:${API_PORT}/v1/metadata"
      echo "METADATA_URL is set to ${METADATA_URL}"
      set +e
      SUCCESS=0
      for i in $(seq 1 25); do
        metadata="$(curl -sk --connect-timeout 5 --max-time 10 "${METADATA_URL}")"
        if [[ $? -eq 0 && "$(jq '.licenseStatus' -r \<<<"$metadata")" != "RESTARTING" ]]; then
          SUCCESS=1
          break
        fi
        sleep 5
      done
      if [[ "${SUCCESS}" == 0 ]]; then
        kubectl -n stackrox get pod
        echo "Failed to connect to Central"
        exit 1
      fi
      cci-export API_HOSTNAME "$API_HOSTNAME"
      cci-export API_PORT "$API_PORT"
      cci-export API_ENDPOINT "${API_HOSTNAME}:${API_PORT}"


jobs:
  build:
    docker:
      - image: docker.io/stackrox/apollo-ci:jenkins-plugin-0.2.8-1-ga776a448ee
        auth:
          username: $DOCKER_IO_PULL_USERNAME
          password: $DOCKER_IO_PULL_PASSWORD
    working_directory: /home/circleci/jenkins-plugin
    steps:
      - checkout
      - run:
          name: Build and package the Jenkins plugin
          command: |
            cd stackrox-k8s-security-platform
            mvn package
            mvn hpi:hpi

      - store_artifacts:
          path: /home/circleci/jenkins-plugin/stackrox-k8s-security-platform/target/stackrox-k8s-security-platform.hpi
          destination: artifacts
  provision-cluster-qa-tests:
   docker:
      - image: docker.io/stackrox/apollo-ci:0.2.8-2-g1e9382b6d6
        auth:
          username: $DOCKER_IO_PULL_USERNAME
          password: $DOCKER_IO_PULL_PASSWORD
   environment:
     - GCP_IMAGE_TYPE: "COS"
     - POD_SECURITY_POLICIES: "true"
   working_directory: /home/circleci/jenkins-plugin
   steps:
    - checkout
    - setup_remote_docker
    - provision-gke-cluster:
        cluster-id: qa-tests
        num-nodes: 2

  deploy-stackrox:
    docker:
      - image: docker.io/stackrox/apollo-ci:0.2.8-2-g1e9382b6d6
        auth:
          username: $DOCKER_IO_PULL_USERNAME
          password: $DOCKER_IO_PULL_PASSWORD
    working_directory: /home/circleci/jenkins-plugin
    parameters:
      orchestrator-flavor:
        type: string
        default: k8s
      require-cluster-admin:
        type: boolean
        default: false
      validate-autoupgrade-label:
        type: boolean
        default: false
      post-central-deploy-steps:
        type: steps
        default: []

    steps:
      - attach_workspace:
          at: /home/circleci/jenkins-plugin
      - run:
          name:
          command: |
            docker run  -i --rm stackrox/main:3.0.36.x-1-gc7c0c7af8e central generate k8s pvc > bundle.zip
            unzip bundle.zip
      - setup_remote_docker
      - attach-gke-cluster:
          cluster-id: qa-tests
      - run:
          name: Deploy central to remote cluster
          command: |
            central/scripts/setup.sh
            kubectl create -R -f central

      - steps: << parameters.post-central-deploy-steps >>

      - *waitForAPI

      - run:
          name: Snapshot Kubernetes Resources
          command: |
            <<# parameters.validate-autoupgrade-label >>
            scripts/ci/sensorbundle-label/list-resources.sh >/tmp/k8s-resources-pre-sensor
            <</ parameters.validate-autoupgrade-label >>
            exit 0

      - run:
          name: Deploy Sensor
          command: |
            <<# parameters.require-cluster-admin >>
            kubectl create clusterrolebinding temporary-admin --clusterrole=cluster-admin --user circleci-rox@stackrox-ci.iam.gserviceaccount.com
            <</ parameters.require-cluster-admin >>

            deploy/<< parameters.orchestrator-flavor >>/sensor.sh
            <<# parameters.require-cluster-admin >>
            kubectl delete clusterrolebinding temporary-admin
            <</ parameters.require-cluster-admin >>

      - run:
          name: Validate Sensor bundle (upgrader)
          command: |
            kubectl proxy --port 28001 &
            proxy_pid=$!
            sleep 5
            KUBECONFIG="$(pwd)/scripts/ci/kube-api-proxy/config.yml" \
              bin/linux/upgrader \
                -kube-config kubectl \
                -local-bundle deploy/<< parameters.orchestrator-flavor >>/sensor-deploy \
                -workflow validate-bundle
            kill "$proxy_pid"

      - *waitForSensorK8s
      - *setupClientTLSCerts
      - setup-egress-proxies
      - *deleteClusterk8s


workflows:
  version: 2
  build:
    jobs:
      - build:
          <<: *runOnAllTagsWithDockerIOPullCtx
      - provision-cluster-qa-tests:
          <<: *runOnAllTagsWithDockerIOPullCtx
      - deploy-stackrox:
          <<: *runOnAllTagsWithDockerIOPullCtx
          orchestrator-flavor: k8s
          requires:
            - provision-cluster-qa-tests

      
commands:
  setup-gcp:
    parameters:
      docker-login:
        type: boolean
        default: true

    steps:
      - run:
          name: Setup deployment env
          command: |
            <<# parameters.docker-login >>
            docker login -u "$DOCKER_IO_PULL_USERNAME" -p "$DOCKER_IO_PULL_PASSWORD"
            <</ parameters.docker-login >>
            cci-export REGISTRY_USERNAME "$DOCKER_IO_PULL_USERNAME"
            cci-export REGISTRY_PASSWORD "$DOCKER_IO_PULL_PASSWORD"
            gcloud auth activate-service-account --key-file <(echo "$GCLOUD_SERVICE_ACCOUNT_CIRCLECI_ROX")
            gcloud auth list
            gcloud config set project stackrox-ci
            gcloud config set compute/region us-central1
            gcloud config unset compute/zone
            gcloud config set core/disable_prompts True

  create-gke:
    parameters:
      wait:
        type: boolean
        default: true

    steps:
      - run:
          name: Create GKE cluster
          command: |
            source .circleci/create-cluster.sh && create-cluster
            <<# parameters.wait >>
            wait-for-cluster
            <</ parameters.wait >>

  provision-gke-cluster:
    parameters:
      cluster-id:
        type: string
      num-nodes:
        type: integer
        default: 3

    steps:
      - setup-gcp:
          docker-login: false
      - run:
          name: Assign environment variables
          command: |
            CLUSTER_NAME="rox-jenkins-plugin-ci-<< parameters.cluster-id >>-${CIRCLE_BUILD_NUM}"
            cci-export CLUSTER_NAME "$CLUSTER_NAME"
            echo "Assigned cluster name is $CLUSTER_NAME"

            NUM_NODES="<< parameters.num-nodes >>"
            cci-export NUM_NODES "$NUM_NODES"
            echo "Number of nodes for cluster is $NUM_NODES"

      - create-gke:
          wait: false

      - run:
          name: Save cluster config
          command: |
                  CONFIG_DIR="/home/circleci/jenkins-plugin/.ci-clusters/<< parameters.cluster-id >>"
                  mkdir -p "$CONFIG_DIR"
                  echo "$CLUSTER_NAME" >>"${CONFIG_DIR}/name"
                  gcloud config get-value compute/zone >>"${CONFIG_DIR}/zone"


      - *buildLivenessCheck

      - persist_to_workspace:
          root: /home/circleci/jenkins-plugin/
          paths:
            - .ci-clusters/<< parameters.cluster-id >>


  setup-egress-proxies:
    steps:
      - run:
          name: Set up egress proxies (if desired)
          command: |
            if ! .circleci/pr_has_label.sh ci-rox-egress-proxies; then
              echo "Not setting up egress proxies"
              exit 0
            fi

            kubectl -n squid apply -R -f tests/proxy/deployment/ || true  # might fail because of SCC
            configs=(tests/proxy/config/*.yaml)

            selected_config="${configs[$((RANDOM % ${#configs[@]}))]}"
            echo "Selected configuration file ${selected_config}"
            kubectl -n stackrox apply -f "${selected_config}"

            echo "Waiting for 3min for proxy config to be picked up"
            for i in {1..180}; do
              echo -n .
              sleep 1
            done
            echo

            if [[ "$CIRCLE_JOB" == "openshift-crio-tests" ]]; then
              echo "Skipping egress isolation on CRI-O due to network policy issues."
              exit 0
            fi

            echo "Isolating pods"
            kubectl -n stackrox apply -R -f tests/proxy/netpol/

  attach-gke-cluster:
    parameters:
      cluster-id:
        type: string

    steps:
      - run:
          name: Restore config for << parameters.cluster-id >> cluster
          command: |
            CONFIG_DIR="/home/circleci/jenkins-plugin/.ci-clusters/<< parameters.cluster-id >>"
            CLUSTER_NAME="$(cat "${CONFIG_DIR}/name")"
            [[ -n "$CLUSTER_NAME" ]]
            ZONE="$(cat "${CONFIG_DIR}/zone")"
            [[ -n "$ZONE" ]]
            gcloud config set compute/zone "$ZONE"
            cmd=(gcloud container clusters get-credentials --project stackrox-ci --zone "$ZONE" "$CLUSTER_NAME")
            "${cmd[@]}"
            echo "Restored config for cluster ${CLUSTER_NAME}"
            cci-export CLUSTER_NAME "$CLUSTER_NAME"
            echo
            echo "Run the following command to attach to the cluster:"
            echo
            printf " %q" "${cmd[@]}"
            echo

